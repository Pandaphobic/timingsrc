<!DOCTYPE html>
<html>
  <head>
    <!-- requirejs config -->
    <script>
      var require = {
        baseUrl : '../',
      };
    </script>
    <!-- requirejs -->
    <script type="text/javascript" src="../../docs/lib/require.js"></script>
    <!--  main -->
    <script text="javascript">

        let to, axis, s, Interval;

        function pprint(ev, s) {
          console.log("exitCues");
            for (let cue of ev.exitCues.values()) {
                console.log(cue.key, cue.interval.toString());
            }
            console.log("enterCues");
            for (let cue of ev.enterCues.values()) {
                console.log(cue.key, cue.interval.toString());
            }
            console.log("activeCues");
            for (let cue of s.values()) {
                console.log(cue.key, cue.interval.toString());
            }
        };

        function run() {

            // Hook up buttons UI
            document.getElementById('a').onclick = function () {
                to.update({position: 1.0});
            };
            document.getElementById('b').onclick = function () {
                to.update({position: 1.3});
            };
            document.getElementById('c').onclick = function () {
                to.update({position: 1.7});
            };
            document.getElementById('d').onclick = function () {
                to.update({position: 2.0});
            };

            document.getElementById('e').onclick = function () {
                to.update({velocity: 1.0});
            };
            document.getElementById('f').onclick = function () {
                to.update({velocity: 0});
            };
            document.getElementById('g').onclick = function () {
                to.update({position: 0});
            };
            document.getElementById('h').onclick = function () {
                to.update({velocity: -1.0});
            };


            let value = document.getElementById("value");
            to.on("timeupdate", function () {
                value.innerHTML = to.query().position.toFixed(2);
            });


            // Visualize list of timed data
            let html = [...axis.values()]
                .sort(function(cue_a, cue_b) {
                    return Interval.cmpLow(cue_a.interval, cue_b.interval);
                }).map(function(cue){
                    return `<div id=${cue.key}>${cue.data}</div>`;
                }).join("\n");
            document.getElementById("data").innerHTML = html;


            // add change handler
            s.on("change", function(eventMap) {
                for (let [key, item] of eventMap.entries()) {
                    let el = document.getElementById(`${key}`);
                    if (!item.new && item.old) {
                        el.classList.remove("active");
                    } else if (item.new && !item.old) {
                        el.classList.add("active");
                    } else if (item.new && item.old) {
                        // noop
                    }
                }
            });
        };


        require(['test/main'], function (timingsrc) {

            Interval = timingsrc.Interval;

            // Axis
            axis = new timingsrc.Axis();

            // fill axis with some cues
            let cues = [];
            for (let i=0; i<20; i++) {
                let j0 = i;
                let j1 = i + 1;
                let itv = new Interval(j0, j1);
                let data =  itv.toString();
                cues.push({key: i, interval:itv, data:data});
            }
            for (let i=0; i<20; i++) {
                let j0 = i + 0.5;
                let j1 = j0 + 1;
                let itv = new Interval(j0, j1);
                let data =  itv.toString();
                cues.push({key: 1000 + i, interval:itv, data:data});
            }
            // add a few singular cues
            for (let i=0; i<20; i+=5) {
                let itv = new Interval(i);
                let data =  itv.toString();
                cues.push({key: 2000 + i, interval:itv, data:data});
            }

            axis.update(cues);

            // initialise
            to = new timingsrc.TimingObject();
            s = new timingsrc.SingleSequencer(axis, to);


            // add change handler
            s.on("change", function(eventMap, eInfo) {
                for (let [key, item] of eventMap.entries()) {
                    if (!item.new && item.old) {
                        console.log("remove", key, item.old.interval.toString());
                    } else if (item.new && !item.old) {
                        console.log("change", key, item.new.interval.toString());
                    } else if (item.new && item.old) {
                        console.log("change", key);
                    }

                }
            });


            if (document.readyState === "complete") {
                run();
            } else {
                window.onload = run;
            };

        });

    </script>

    <style type="text/css">
        .active {color:red}
    </style>

  </head>
  <body>
    <h1>Test Single Sequencer</h1>
    <div id="value"></div>
    <p>
    <button id="a">1.0</button>
    <button id="b">1.3</button>
    <button id="c">1.7</button>
    <button id="d">2.0</button>
    </p>
    <p>
    <button id="e">Play</button>
    <button id="f">Pause</button>
    <button id="g">Reset</button>
    <button id="h">Backwards</button>
    </p>
    <p>
      <div id="data"></div>
    </p>

  </body>
</html>
