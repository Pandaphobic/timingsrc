<!DOCTYPE html>
<html>
  <head>
    <!-- requirejs config -->
    <script>
      var require = {
        baseUrl : '../',
      };
    </script>
    <!-- requirejs -->
    <script type="text/javascript" src="../../docs/lib/require.js"></script>
    <!--  main -->
    <script text="javascript">

        let to, axis, s, Interval;

        function pprint(ev, s) {
          console.log("exitCues");
            for (let cue of ev.exitCues.values()) {
                console.log(cue.key, cue.interval.toString());
            }
            console.log("enterCues");
            for (let cue of ev.enterCues.values()) {
                console.log(cue.key, cue.interval.toString());
            }
            console.log("activeCues");
            for (let cue of s.values()) {
                console.log(cue.key, cue.interval.toString());
            }
        };

        function run() {

            // position controls
            document.getElementById('a').onclick = function () {
                to.update({position: -1.0});
            };
            document.getElementById('b').onclick = function () {
                to.update({position: 0});
            };
            document.getElementById('c').onclick = function () {
                to.update({position: 1.0});
            };
            document.getElementById('d').onclick = function () {
                let pos = to.query().position;
                to.update({position: pos + 1.0});
            };
            document.getElementById('e').onclick = function () {
                let pos = to.query().position;
                to.update({position: pos - 1.0});
            };


            // velocity controls
            document.getElementById('f').onclick = function () {
                to.update({velocity: -1.0});
            };
            document.getElementById('g').onclick = function () {
                to.update({velocity: 0});
            };
            document.getElementById('h').onclick = function () {
                to.update({velocity: 1.0});
            };
            document.getElementById('i').onclick = function () {
                let vel = to.query().velocity;
                to.update({velocity: vel + 1.0});
            };
            document.getElementById('j').onclick = function () {
                let vel = to.query().velocity;
                to.update({velocity: vel - 1.0});
            };


            // acceleration controls
            document.getElementById('k').onclick = function () {
                to.update({acceleration: -1.0});
            };
            document.getElementById('l').onclick = function () {
                to.update({acceleration: 0.0});
            };
            document.getElementById('m').onclick = function () {
                to.update({acceleration: 1.0});
            };
            document.getElementById('n').onclick = function () {
                let acc = to.query().acceleration;
                to.update({acceleration: acc + 1.0});
            };
            document.getElementById('o').onclick = function () {
                let acc = to.query().acceleration;
                to.update({acceleration: acc - 1.0});
            };


            let value = document.getElementById("value");
            to.on("timeupdate", function () {
                let v = to.query();
                let pos = v.position.toFixed(2)
                let vel = v.velocity.toFixed(2)
                let acc = v.acceleration.toFixed(2)
                value.innerHTML = `P:${pos} V:${vel} A:${acc}`;
            });


            // Visualize list of timed data
            let html = [...axis.values()]
                .sort(function(cue_a, cue_b) {
                    return Interval.cmpLow(cue_a.interval, cue_b.interval);
                }).map(function(cue){
                    return `<div id=${cue.key}>${cue.data}</div>`;
                }).join("\n");
            document.getElementById("data").innerHTML = html;


            // add change handler
            s.on("change", function(events) {
                events.forEach(function(item){
                    let el = document.getElementById(`${item.key}`);
                    if (!item.new && item.old) {
                        el.classList.remove("active");
                    } else if (item.new && !item.old) {
                        el.classList.add("active");
                    } else if (item.new && item.old) {
                        // noop
                    }
                });
            });
        };


        require(['test/main'], function (timingsrc) {

            Interval = timingsrc.Interval;

            // Axis
            axis = new timingsrc.Axis();

            // fill axis with some cues
            let cues = [];
            for (let i=0; i<20; i++) {
                let j0 = i;
                let j1 = i + 1;
                let itv = new Interval(j0, j1);
                let data =  itv.toString();
                cues.push({key: i, interval:itv, data:data});
            }
            for (let i=0; i<20; i++) {
                let j0 = i + 0.5;
                let j1 = j0 + 1;
                let itv = new Interval(j0, j1);
                let data =  itv.toString();
                cues.push({key: 1000 + i, interval:itv, data:data});
            }
            // add a few singular cues
            for (let i=0; i<20; i+=5) {
                let itv = new Interval(i);
                let data =  itv.toString();
                cues.push({key: 2000 + i, interval:itv, data:data});
            }

            axis.update(cues);

            // initialise
            to = new timingsrc.TimingObject({range:[0,20], vector:{position:1.0}});
            s = new timingsrc.SingleSequencer(axis, to);


            // add change handler
            s.on("change", function(events, eInfo) {
                events.forEach(function(item){
                    if (!item.new && item.old) {
                        console.log("remove", item.key, item.old.interval.toString());
                    } else if (item.new && !item.old) {
                        console.log("change", item.key, item.new.interval.toString());
                    } else if (item.new && item.old) {
                        console.log("change", item.key);
                    }
                });
            });


            if (document.readyState === "complete") {
                run();
            } else {
                window.onload = run;
            };

        });

    </script>

    <style type="text/css">
        .active {color:red}
    </style>

  </head>
  <body>
    <h1>Test Single Sequencer</h1>
    <div id="value" style="font-weight:bold;"></div>
    <p>
    <button id="a">P=-1</button>
    <button id="b">P=0</button>
    <button id="c">P=1</button>
    <button id="d">P.inc</button>
    <button id="e">P.dec</button>
    </p>
    <p>
    <button id="f">V=-1</button>
    <button id="g">V=0</button>
    <button id="h">V=1</button>
    <button id="i">V.inc</button>
    <button id="j">V.dec</button>
    </p>
    <p>
    <button id="k">A=-1</button>
    <button id="l">A=0</button>
    <button id="m">A=1</button>
    <button id="n">A.inc</button>
    <button id="o">A.dec</button>
    </p>
    <h3>Timed Data</h3>
    <p>Active cues in red color</p>
    <p>
      <div id="data"></div>
    </p>

  </body>
</html>
